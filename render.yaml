services:
  - type: web
    name: newsai
    runtime: python
    region: singapore  # Deploy to Singapore region
    buildCommand: pip install -r requirements.txt
    startCommand: python app.py
    disk:
      name: newsai-data
      mountPath: /data
      sizeGB: 1
    envVars:
      - key: CRON_AUTH_TOKEN
        generateValue: true
    autoDeploy: true

  - type: cron
    name: newsai-daily-digest
    runtime: python
    region: singapore  # Deploy to Singapore region
    schedule: "0 3 * * *"  # Daily at 3 AM UTC (7 AM UAE time)
    buildCommand: pip install -r requirements.txt
    startCommand: |
      python -c "
      import os
      import requests
      from datetime import datetime
      
      # Get the hostname from Render
      hostname = os.environ.get('RENDER_EXTERNAL_HOSTNAME')
      if not hostname:
          print('ERROR: RENDER_EXTERNAL_HOSTNAME not set')
          print('Available env vars:', list(os.environ.keys()))
          exit(1)
      
      # Construct the full URL - hostname might already include .onrender.com
      if '.onrender.com' in hostname or '.' in hostname:
          app_url = f'https://{hostname}'
      else:
          app_url = f'https://{hostname}.onrender.com'
      token = os.environ.get('CRON_AUTH_TOKEN')
      
      is_monday = datetime.now().weekday() == 0
      digest_type = 'Monday (News + Stocks)' if is_monday else 'Daily News'
      print(f'Triggering {digest_type} for {app_url}...')
      
      # Single endpoint handles both daily news and Monday stocks
      response = requests.post(
          f'{app_url}/api/trigger/daily-digest',
          headers={'X-Auth-Token': token}
      )
      
      print(f'{digest_type} digest trigger: {response.status_code}')
      
      if response.status_code == 200:
          print(response.json())
      else:
          print(f'Error: {response.text}')
      "
    envVars:
      - key: CRON_AUTH_TOKEN
        fromService:
          type: web
          name: newsai
          envVarKey: CRON_AUTH_TOKEN
      - key: RENDER_EXTERNAL_HOSTNAME
        fromService:
          type: web
          name: newsai
          property: host